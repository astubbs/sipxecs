<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<mappings xmlns="http://www.sipfoundry.org/sipX/schema/xml/urlmap-00-00">
  <hostMatch>
    <hostPattern>${SIPXCHANGE_DOMAIN_NAME}</hostPattern>
    <hostPattern>${MY_IP_ADDR}</hostPattern>

    <!-- Support ISN dialing: match on "digits*digits" -->
    <userMatch>
      <userPattern>x.*x.</userPattern>
      <permissionMatch>
        <transform>
          <url>&lt;sip:{digits}@freenum.org&gt;</url>
        </transform>
      </permissionMatch>
    </userMatch>

    <!-- Sample mapping rule for 105 forwarding prefix -->
    <!-- Forwards 105xxx to sip:xxx@example.com -->
    <userMatch>
      <userPattern>105x.</userPattern>
      <permissionMatch>
        <transform>
          <url>&lt;sip:{vdigits}@example.com&gt;</url>
        </transform>
      </permissionMatch>
    </userMatch>

    <!-- 'operator', '0', or extension 100 goes to AutoAttendant -->
    <userMatch>
      <userPattern>operator</userPattern>
      <userPattern>100</userPattern>
      <userPattern>0</userPattern>
      <permissionMatch>
        <transform>
          <url>&lt;sip:{digits}@{mediaserver};play={voicemail}%2Fcgi-bin%2Fvoicemail%2Fmediaserver.cgi%3Faction%3Dautoattendant&gt;</url>
        </transform>
      </permissionMatch>
    </userMatch>

    <!-- extension 101 is used to retrieve voicemail messages -->
    <userMatch>
      <userPattern>101</userPattern>
      <permissionMatch>
        <transform>
          <url>&lt;sip:{digits}@{mediaserver};play={voicemail}%2Fcgi-bin%2Fvoicemail%2Fmediaserver.cgi%3Faction%3Dretrieve&gt;</url>
        </transform>
      </permissionMatch>
    </userMatch>

    <!-- Voice Mail Fallback
      - add a voicemail fallback for any user with the Voicemail permission.
      -->
    <userMatch>
      <userPattern>1xxx</userPattern>
      <permissionMatch>
        <permission>Voicemail</permission>
        <transform>
          <url>&lt;sip:{digits}@{mediaserver};play={voicemail}%2Fcgi-bin%2Fvoicemail%2Fmediaserver.cgi%3Faction%3Ddeposit%26mailbox%3D{digits}&gt;;q=0.1</url>
        </transform>
      </permissionMatch>
    </userMatch>

    <!-- Direct Voice Mail Deposit
      - 2<ext> goes direct to voicemail box for any user with voicemail
      -->
    <userMatch>
      <userPattern>2xx[12]</userPattern>
      <permissionMatch>
        <transform>
          <url>&lt;sip:1{vdigits}@{mediaserver};play={voicemail}%2Fcgi-bin%2Fvoicemail%2Fmediaserver.cgi%3Faction%3Ddeposit%26mailbox%3D1{vdigits}&gt;</url>
        </transform>
      </permissionMatch>
    </userMatch>

    <!-- Valid User Transforms
      - change 3<ext> so that it is challenged when it gets to the
      - authproxy, and any valid user can make the call.
      -->
    <userMatch>
      <userPattern>3xxx</userPattern>
      <permissionMatch>
        <transform>
          <user>validuser_{vdigits}</user>
        </transform>
      </permissionMatch>
    </userMatch>
    <userMatch>
      <userPattern>validuser_xxx</userPattern>
      <permissionMatch>
        <transform>
          <user>1{vdigits}</user>
        </transform>
      </permissionMatch>
    </userMatch>

    <!-- BigShot Transforms
      - change 4<ext> so that it is challenged when it gets to the
      - authproxy, and only users with BigShot permission can make
      - the call.
      -->
    <userMatch>
      <userPattern>4xxx</userPattern>
      <permissionMatch>
        <transform>
          <user>bigshot_{vdigits}</user>
        </transform>
      </permissionMatch>
    </userMatch>
    <userMatch>
      <userPattern>bigshot_xxx</userPattern>
      <permissionMatch>
        <transform>
          <user>1{vdigits}</user>
        </transform>
      </permissionMatch>
    </userMatch>

    <!-- Long Path
      - For 7<ext>, put extra spirals in the path to test large messages
      - and many vias.
      -->
    <userMatch>
      <userPattern>7xxx</userPattern>
      <permissionMatch>
        <transform>
          <user>hop1_{vdigits}</user>
        </transform>
      </permissionMatch>
    </userMatch>
    <userMatch>
      <userPattern>hop1_xxx</userPattern>
      <permissionMatch>
        <transform>
          <user>hop2_{vdigits}</user>
        </transform>
      </permissionMatch>
    </userMatch>
    <userMatch>
      <userPattern>hop2_xxx</userPattern>
      <permissionMatch>
        <transform>
          <user>hop3_{vdigits}</user>
        </transform>
      </permissionMatch>
    </userMatch>
    <userMatch>
      <userPattern>hop3_xxx</userPattern>
      <permissionMatch>
        <transform>
          <user>1{vdigits}</user>
        </transform>
      </permissionMatch>
    </userMatch>

    <!-- Multiple Invites
      - For 8<ext>, fork the call and spiral both forks so that the
      - same call is received at the target with different branch ids
      - The first should be accepted, and the second rejected.
      -->
    <userMatch>
      <userPattern>8xxx</userPattern>
      <permissionMatch>
        <transform>
          <user>call1_{vdigits}</user>
        </transform>
        <transform>
          <user>call2_{vdigits}</user>
        </transform>
      </permissionMatch>
    </userMatch>
    <userMatch>
      <userPattern>call1_xxx</userPattern>
      <userPattern>call2_xxx</userPattern>
      <permissionMatch>
        <transform>
          <user>1{vdigits}</user>
        </transform>
      </permissionMatch>
    </userMatch>

    <!-- Infinite Loop
      -  Forces a Too Many Hops error to be returned.
      -->
    <userMatch>
      <userPattern>9999</userPattern>
      <permissionMatch>
        <transform>
          <user>InfiniteLoop</user>
        </transform>
      </permissionMatch>
    </userMatch>
    <userMatch>
      <userPattern>InfiniteLoop</userPattern>
      <permissionMatch>
        <transform>
          <user>LoopForever</user>
        </transform>
      </permissionMatch>
    </userMatch>
    <userMatch>
      <userPattern>LoopForever</userPattern>
      <permissionMatch>
        <transform>
          <user>InfiniteLoop</user>
        </transform>
      </permissionMatch>
    </userMatch>

  </hostMatch>
</mappings>
