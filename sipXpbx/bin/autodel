#!/bin/bash

# Confirm if no user was specified
while [ -z "$1" ]
do
        echo -n "Delete all IPC resources owned by $USER? [y/N] "
        read response
        case "$response" in
                y* | Y*)
                        break
                ;;
                n* | N* | "")
                        exit
                ;;
        esac
done

OWNER=`echo ${1:-$USER} | cut -c 1-8`

# 24 hours ago
TIME_LIMIT=$(( $( date +%s ) - 86400 ))

# Parse the output of ipcs for the IDs of the resources we want to delete.

ipcs -s -t | grep "$OWNER" |
while read LINE
do
  # If the last-op time is far enough in the past, purge it.
  # (Beware that the last-op time can be "not set".)
  if [[ "${LINE:25:20}" != 'set                 ' ]] && \
     (( $( date -d "${LINE:25:20}" +%s ) < $TIME_LIMIT ))
  then
      echo ipcrm sem ${LINE:0:8}
      ipcrm sem ${LINE:0:8}
  fi
done

# Parse the output of ipcs for the IDs of the resources we want to delete.

ipcs -m -t | grep "$OWNER" |
while read LINE
do
  if (( $( date -d "${LINE:65:15}" +%s ) < $TIME_LIMIT ))
  then
      echo ipcrm shm ${LINE:0:8}
      ipcrm shm ${LINE:0:8}
  fi
done
